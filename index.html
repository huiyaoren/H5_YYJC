<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
    <link href="app/static/css/index.css" rel="stylesheet">
    <script src="app/static/js/jquery-1.12.0.min.js"></script>
    <script src="app/static/js/Controller.js"></script>
    <script src="app/static/js/Director.js"></script>
    <script src="app/static/js/Speedometer.js"></script>
    <script src="app/static/js/Map.js"></script>
    <script src="app/static/js/Scene.js"></script>
    <script src="app/static/js/Role.js"></script>
    <script src="app/static/js/Database.js"></script>
    <script src="app/static/js/jquery.validate.js"></script>
    <script src="app/static/js/messages_zh.js"></script>
    <script>
        $(function () {

            var director = new Director($(_scene));
            var loginScene = new LoginScene(); // todo 登陆一次后保留账号信息 不用再次输入
            var signScene = new SignScene();
            var mainScene = new MainScene();
            var mapScene = new MapScene();
            var shopScene = new ShopScene();
            var gameScene = new GameScene();
            var resultScene = new ResultScene();
            var stageScene = new StageScene();
//            var readyScene = new ReadyScene();
            var db = openDatabase('db', 2, 'db', 1024 * 1024);
            var user = new TB_User(db);
            var biker = new TB_Biker(db);
            var moto = new TB_Moto(db);
            var wheel = new TB_Wheel(db);
            var engine = new TB_Engine(db);


//            var s = '[1, 1, 2, 2]';
//            console.log(s);// todo
//            console.log(eval(String(s)));// todo
//            console.log('[' + String(eval(String(s)))+']');// todo

            user.create();

            biker.drop();
            biker.create();
            biker.insert([2, 'kill_you', '角色2', 0, 'biker/c2s.png', 'biker/c2.png', 'biker/cha2.png']);
            biker.insert([3, 'need_to_pee', '角色3', 200, 'biker/c3s.png', 'biker/c3.png', 'biker/cha3.png']);
            biker.insert([4, 'run_away', '角色4', 200, 'biker/c4s.png', 'biker/c4.png', 'biker/cha4.png']);
            biker.insert([5, 'ohh_shit', '角色5', 200, 'biker/c5s.png', 'biker/c5.png', 'biker/cha5.png']);
            biker.insert([6, 'you_jump', '角色6', 200, 'biker/c6s.png', 'biker/c6.png', 'biker/cha6.png']);
            biker.insert([7, 'i_jump', '角色7', 200, 'biker/c7s.png', 'biker/c7.png', 'biker/cha7.png']);
            biker.insert([8, 'you_idiot', '角色8', 200, 'biker/c8s.png', 'biker/c8.png', 'biker/cha8.png']);

            moto.drop();
            moto.create();
            moto.insert([101, 100, '车身1', 0, 'moto/m1s.png', 'moto/m1.png']);
            moto.insert([102, 105, '车身2', 100, 'moto/m2s.png', 'moto/m2.png']);
            moto.insert([103, 110, '车身3', 200, 'moto/m3s.png', 'moto/m3.png']);
            moto.insert([104, 115, '车身4', 300, 'moto/m4s.png', 'moto/m4.png']);

            wheel.drop();
            wheel.create();
            wheel.insert([201, 5, '车轮1', 0, 'wheel/w1s.png', 'wheel/w1.png']);
            wheel.insert([202, 6, '车轮2', 100, 'wheel/w2s.png', 'wheel/w2.png']);
            wheel.insert([203, 7, '车轮3', 200, 'wheel/w3s.png', 'wheel/w3.png']);
            wheel.insert([204, 8, '车轮4', 250, 'wheel/w4s.png', 'wheel/w4.png']);

            engine.drop();
            engine.create();
            engine.insert([301, 1, '引擎1', 0, 'engine/engine1.png']);
            engine.insert([302, 2, '引擎2', 100, 'engine/engine2.png']);
            engine.insert([303, 3, '引擎3', 150, 'engine/engine3.png']);
            engine.insert([304, 4, '引擎4', 200, 'engine/engine4.png']);
            engine.insert([305, 5, '引擎5', 250, 'engine/engine5.png']);
            engine.insert([306, 6, '引擎6', 300, 'engine/engine6.png']);

//            user.update(["password=234234", "username=123123"]);
//            user.insert(['123123', '123123', 'admin', 9999, 99, '[[],[],[],[]]', '[[],[],[],[]]', '[]']);
//            user.drop();


            mainScene.bind("returnToLogin1", function () {
                director.runScene(shopScene);
                // todo 清空 localstorage
            });

// ---------------------------- -----------------------------------------------

            director.runScene(stageScene);

            loginScene.bind("clickSignButton", function () {
                director.runScene(signScene);
            });

            signScene.bind("returnToLogin", function () {
                director.runScene(loginScene);
            });

            signScene.bind("signSuccess", function (e, form) {
                var username = $(form).children("input[name=username]").val();
                var password = $(form).children("input[name=password1]").val();


                user.select(['*', "username='" + username + "'"], function (result) {

                    console.log("查找用户名结果数|注册：" + result.rows.length);

                    if (result.rows.length != 0) {
                        alert("该账号名已被使用");
                    }
                    else if (result.rows.length == 0) {

                        user.insert([
                            username,
                            password,
                            username,
                            9999,
                            99,
                            '[[],[],[],[]]',
                            '[[],[],[],[]]',
                            '[]'
                        ]);
                        // todo 用户数据存至localstorage
                        alert("注册成功,将跳转至登陆界面");
                        director.runScene(loginScene);
                    }
                });
            });

            loginScene.bind("loginCorrect", function (e, form) {

                var username = $(form).children("input[name=username]").val();
                var password = $(form).children("input[name=password]").val();

//                console.log(form)
                user.select(['*', "username='" + username + "'"], function (result) {
//                    console.log(result.rows);
                    console.log("数据匹配用户名数量|登陆: " + result.rows.length);
                    if (result.rows.length == 0) {

                        alert("账号名不存在");

                    } else {

                        // 验证密码
                        console.log("用户数据库密码|登陆: " + result.rows.item(0).password);

                        if (password == result.rows.item(0).password) {
                            alert('登陆成功');
                            director.runScene(mainScene);
                        } else {
                            alert('密码错误');
                            $(form).children("input[name=password]").val("")
                        }
                    }
                });

            });

//            loginScene.bind("clickSettingButton", function(){
//                director.runScene(settingScene);
//            });
//            settingScene.bind("finishSetting", function(){
//                director.runScene(loginScene);
//            });
//
            mainScene.bind("clickShopButton", function () {
                director.runScene(shopScene);
            });

            shopScene.bind("LoadShop", function (e, shop, review) {
//                alert(); //todo ?? 直接载入不执行 从主界面跳转才执行

                function load_item(result) {
                    $(shop).empty();
                    for (var i = 0; i < result.rows.length; i++) {
//                        var $item = $("<div class='_shopItem'></div>")
                        var $item = $('\
                            <div class="_shopItem" data-id="' + result.rows.item(i).id + '">\
                                <h2>' + result.rows.item(i).name + '</h2>\
                                <img src="app/static/img/' + result.rows.item(i).img_1 + '">\
                                <span>价格：' + result.rows.item(i).price + '</span>\
                                <button></button>\
                                <button></button>\
                            </div>\
                        ');
//                        console.log($item[0]);
                        // todo 购买与预览功能

                        $(shop).append($item);// todo
                    }
                }

                biker.select(['*', 'id>0'], function (result) {
                    console.log("查询结果数量|角色：" + result.rows.length);
                    load_item(result);
                });

                shopScene.bind("loadMotoItem", function () {
                    moto.select(['*', 'id>0'], function (result) {
                        console.log("查询结果数量|车身：" + result.rows.length);
                        load_item(result);
                    });
                });
                shopScene.bind("loadBikerItem", function () {
                    biker.select(['*', 'id>0'], function (result) {
                        console.log("查询结果数量|角色：" + result.rows.length);
                        load_item(result);
                    });
                });
                shopScene.bind("loadEngineItem", function () {
                    engine.select(['*', 'id>0'], function (result) {
                        console.log("查询结果数量|引擎：" + result.rows.length);
                        load_item(result);
                    });
                });
                shopScene.bind("loadWheelItem", function () {
                    wheel.select(['*', 'id>0'], function (result) {
                        console.log("查询结果数量|车轮：" + result.rows.length);
                        load_item(result);
                    });
                });
                shopScene.bind("returnToMain", function () {
                    director.runScene(mainScene);
                });


                // todo 用户预览信息载入
//                $(review).children("h1").html()
            });

//            shopScene.bind("finishShopping", function(){
//                director.runScene(mainScene);
//            });

            mainScene.bind("clickPlayButton", function () {
                director.runScene(stageScene);
            });

//            stageScene.bind("chooseStage", function(){
//                director.runScene(readyScene);
//            });
//            readyScene.bind("startGame", function(){
//                director.runScene(gameScene);
//            });
//            gameScene.bind("finishGame", function(){
//                director.runScene(rankScene);
//            });
//            rankScene.bind("clickNextButton", function(){
//                director.runScene(rankScene);
//            });
        })
    </script>
</head>
<body>
<div id="_scene" style="width: 100%; height: 100%"></div>
</body>
</html>